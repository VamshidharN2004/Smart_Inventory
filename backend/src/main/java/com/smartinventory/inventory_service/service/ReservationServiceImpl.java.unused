package com.smartinventory.inventory_service.service;

import java.time.LocalDateTime;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.smartinventory.inventory_service.model.Reservation;
import com.smartinventory.inventory_service.model.ReservationStatus;
import com.smartinventory.inventory_service.exception.InventoryException;
import com.smartinventory.inventory_service.repository.ReservationRepository;

@Service
public class ReservationServiceImpl implements ReservationService {

    private static final int EXPIRY_MINUTES = 5;

    private final ReservationRepository reservationRepository;
    private final InventoryService inventoryService;

    public ReservationServiceImpl(
            ReservationRepository reservationRepository,
            InventoryService inventoryService) {
        this.reservationRepository = reservationRepository;
        this.inventoryService = inventoryService;
    }

    // ðŸ”¥ RESERVE INVENTORY
    @Override
    @Transactional
    public Reservation reserve(String sku, int quantity, String userId) {

        // 1ï¸âƒ£ Reduce inventory FIRST (safe)
        inventoryService.reduceAvailableQuantity(sku, quantity);

        // 2ï¸âƒ£ Create reservation
        Reservation reservation = new Reservation();
        reservation.setSku(sku);
        reservation.setQuantity(quantity);
        reservation.setUserId(userId);
        reservation.setStatus(ReservationStatus.RESERVED);
        reservation.setExpiryTime(
                LocalDateTime.now().plusMinutes(EXPIRY_MINUTES));

        // 3ï¸âƒ£ Save & return
        return reservationRepository.save(reservation);
    }

    // âœ… CONFIRM
    @Override
    @Transactional
    public void confirmReservation(String reservationId) {

        Reservation reservation = reservationRepository.findById(reservationId)
                .orElseThrow(() -> new InventoryException("Reservation not found"));

        if (reservation.getStatus() == ReservationStatus.CONFIRMED) {
            return; // idempotent
        }

        if (reservation.getStatus() != ReservationStatus.RESERVED) {
            throw new InventoryException("Reservation cannot be confirmed");
        }

        reservation.setStatus(ReservationStatus.CONFIRMED);
        reservationRepository.save(reservation);
    }

    // âŒ CANCEL
    @Override
    @Transactional
    public void cancelReservation(String reservationId) {

        Reservation reservation = reservationRepository.findById(reservationId)
                .orElseThrow(() -> new InventoryException("Reservation not found"));

        if (reservation.getStatus() != ReservationStatus.RESERVED) {
            return; // idempotent
        }

        reservation.setStatus(ReservationStatus.CANCELLED);

        // restore inventory
        inventoryService.restoreAvailableQuantity(
                reservation.getSku(),
                reservation.getQuantity());

        reservationRepository.save(reservation);
    }
}
